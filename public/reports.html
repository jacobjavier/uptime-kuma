<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes - iCentral</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .stats-card {
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 24px;
            color: white;
        }
        .navbar-brand img {
            width: 40px;
            height: 40px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/dashboard">
                <img src="/logo.png" alt="iCentral" class="me-2">
                <span class="fs-4">iCentral</span>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a class="nav-link active" href="/reports.html">
                    <i class="fas fa-chart-line"></i> Reportes
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <h1 class="mb-4">
            <i class="fas fa-chart-line"></i> Centro de Reportes - iCentral
        </h1>

        <!-- Estadísticas Rápidas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card bg-success text-white">
                    <div class="card-body text-center">
                        <div class="stats-icon bg-success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h4 id="monitorsUp">6</h4>
                        <p>Monitores Funcionando</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-danger text-white">
                    <div class="card-body text-center">
                        <div class="stats-icon bg-danger">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <h4 id="monitorsDown">0</h4>
                        <p>Monitores Caídos</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-info text-white">
                    <div class="card-body text-center">
                        <div class="stats-icon bg-info">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <h4 id="overallUptime">95.8%</h4>
                        <p>Disponibilidad General</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-warning text-white">
                    <div class="card-body text-center">
                        <div class="stats-icon bg-warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h4 id="avgResponse">156ms</h4>
                        <p>Tiempo Promedio</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Selector de Grupo/Monitor -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-filter"></i> Filtrar Reportes
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Grupo de Monitores</label>
                                <select id="groupFilter" class="form-select" onchange="filterByGroup()">
                                    <option value="all">Todos los Grupos</option>
                                    <option value="bgp4">BGP IPv4</option>
                                    <option value="bgp6">BGP IPv6</option>
                                    <option value="dns">DNS</option>
                                    <option value="storage">Almacenes</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Período</label>
                                <select id="periodFilter" class="form-select" onchange="updatePeriod()">
                                    <option value="24h">Últimas 24 horas</option>
                                    <option value="7d" selected>Últimos 7 días</option>
                                    <option value="30d">Últimos 30 días</option>
                                    <option value="90d">Últimos 90 días</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-download"></i> Exportar Reportes
                        </h5>
                        <div class="d-grid gap-2 d-md-flex">
                            <button onclick="exportJSON()" class="btn btn-primary">
                                <i class="fas fa-file-code"></i> Exportar JSON
                            </button>
                            <button onclick="exportCSV()" class="btn btn-success">
                                <i class="fas fa-file-csv"></i> Exportar CSV
                            </button>
                            <button onclick="exportIncidents()" class="btn btn-warning">
                                <i class="fas fa-exclamation-triangle"></i> Solo Incidentes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla Principal de Monitores -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-list"></i> Estado Detallado de Monitores
                </h5>
                <div class="table-responsive">
                    <table class="table table-striped" id="monitorsTable">
                        <thead>
                            <tr>
                                <th>Grupo</th>
                                <th>Monitor</th>
                                <th>Estado Actual</th>
                                <th>Disponibilidad</th>
                                <th>Último Incidente</th>
                                <th>Tiempo Caído Total</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="monitorsTableBody">
                            <!-- Se llena dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Historial de Incidentes -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-history"></i> Historial de Incidentes
                </h5>
                <div class="table-responsive">
                    <table class="table table-hover" id="incidentsTable">
                        <thead>
                            <tr>
                                <th>Fecha/Hora Inicio</th>
                                <th>Monitor</th>
                                <th>Duración</th>
                                <th>Causa</th>
                                <th>Estado</th>
                                <th>Fecha/Hora Fin</th>
                            </tr>
                        </thead>
                        <tbody id="incidentsTableBody">
                            <!-- Se llena dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Datos completos de todos los monitores organizados por grupo
        const allMonitors = {
            bgp4: [
                {
                    name: "BGP iCentral",
                    status: "up",
                    uptime: 94.74,
                    lastIncident: "2025-09-26 11:44:08",
                    totalDowntime: "2h 15m",
                    cause: "Timeout de red",
                    responseTime: "156ms"
                },
                {
                    name: "BGP4 Sparkle Local",
                    status: "up", 
                    uptime: 100,
                    lastIncident: null,
                    totalDowntime: "0m",
                    cause: null,
                    responseTime: "89ms"
                },
                {
                    name: "BGPv4 Sparkle Gw",
                    status: "up",
                    uptime: 100,
                    lastIncident: null,
                    totalDowntime: "0m", 
                    cause: null,
                    responseTime: "112ms"
                },
                {
                    name: "BGPv4 Zayo Gw",
                    status: "up",
                    uptime: 100,
                    lastIncident: null,
                    totalDowntime: "0m",
                    cause: null,
                    responseTime: "134ms"
                }
            ],
            bgp6: [
                {
                    name: "BGPv6 Zayo Local",
                    status: "down",
                    uptime: 0,
                    lastIncident: "2025-09-26 11:44:08",
                    totalDowntime: "6h 45m",
                    cause: "Network unreachable",
                    responseTime: "N/A"
                },
                {
                    name: "BGPv6 Sparkle Local",
                    status: "down",
                    uptime: 0,
                    lastIncident: "2025-09-26 11:42:57", 
                    totalDowntime: "6h 47m",
                    cause: "Network unreachable",
                    responseTime: "N/A"
                },
                {
                    name: "BGPv6 Sparkle Gw",
                    status: "down",
                    uptime: 0,
                    lastIncident: "2025-09-26 11:42:09",
                    totalDowntime: "6h 48m",
                    cause: "Network unreachable", 
                    responseTime: "N/A"
                }
            ],
            dns: [
                {
                    name: "DNS Resolver",
                    status: "up",
                    uptime: 99.5,
                    lastIncident: "2025-09-25 14:30:00",
                    totalDowntime: "15m",
                    cause: "DNS timeout",
                    responseTime: "45ms"
                },
                {
                    name: "DNS Secundario",
                    status: "up",
                    uptime: 99.8,
                    lastIncident: null,
                    totalDowntime: "5m",
                    cause: null,
                    responseTime: "38ms"
                }
            ],
            storage: [
                {
                    name: "Almacenes de Datos",
                    status: "up",
                    uptime: 99.9,
                    lastIncident: null,
                    totalDowntime: "2m",
                    cause: null,
                    responseTime: "25ms"
                },
                {
                    name: "Backup Storage",
                    status: "up",
                    uptime: 100,
                    lastIncident: null,
                    totalDowntime: "0m",
                    cause: null,
                    responseTime: "18ms"
                }
            ]
        };

        // Incidentes históricos
        const incidents = [
            {
                start: "2025-09-26 11:44:08",
                end: null,
                monitor: "BGPv6 Zayo Local",
                duration: "6h 45m",
                cause: "Network unreachable",
                status: "ongoing"
            },
            {
                start: "2025-09-26 11:42:57", 
                end: null,
                monitor: "BGPv6 Sparkle Local",
                duration: "6h 47m",
                cause: "Network unreachable",
                status: "ongoing"
            },
            {
                start: "2025-09-26 11:42:09",
                end: null,
                monitor: "BGPv6 Sparkle Gw", 
                duration: "6h 48m",
                cause: "Network unreachable",
                status: "ongoing"
            },
            {
                start: "2025-09-25 14:30:00",
                end: "2025-09-25 14:45:00",
                monitor: "DNS Resolver",
                duration: "15m",
                cause: "DNS timeout",
                status: "resolved"
            },
            {
                start: "2025-09-24 09:15:00",
                end: "2025-09-24 11:30:00", 
                monitor: "BGP iCentral",
                duration: "2h 15m",
                cause: "Timeout de red",
                status: "resolved"
            }
        ];

        let currentFilter = 'all';

        // Cargar datos al inicio
        document.addEventListener('DOMContentLoaded', function() {
            updateTimestamp();
            loadMonitorsTable();
            loadIncidentsTable();
            updateStats();
        });

        function updateTimestamp() {
            const now = new Date().toLocaleString('es-ES');
            const lastUpdateElement = document.getElementById('lastUpdate');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = now;
            }
        }

        function loadMonitorsTable() {
            const tbody = document.getElementById('monitorsTableBody');
            tbody.innerHTML = '';

            Object.keys(allMonitors).forEach(group => {
                if (currentFilter === 'all' || currentFilter === group) {
                    allMonitors[group].forEach(monitor => {
                        const row = createMonitorRow(group.toUpperCase(), monitor);
                        tbody.appendChild(row);
                    });
                }
            });
        }

        function createMonitorRow(group, monitor) {
            const row = document.createElement('tr');
            
            const statusBadge = monitor.status === 'up' ? 
                `<span class="badge bg-success">Funcionando</span>` :
                `<span class="badge bg-danger">Caído</span>`;
                
            const uptimeBadge = monitor.uptime >= 99 ?
                `<span class="badge bg-success">${monitor.uptime}%</span>` :
                monitor.uptime >= 95 ?
                `<span class="badge bg-warning">${monitor.uptime}%</span>` :
                `<span class="badge bg-danger">${monitor.uptime}%</span>`;

            row.innerHTML = `
                <td><strong>${group}</strong></td>
                <td>${monitor.name}</td>
                <td>${statusBadge}</td>
                <td>${uptimeBadge}</td>
                <td>${monitor.lastIncident || 'N/A'}</td>
                <td>${monitor.totalDowntime}</td>
                <td>
                    <button onclick="exportMonitor('${monitor.name}')" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                </td>
            `;
            
            return row;
        }

        function loadIncidentsTable() {
            const tbody = document.getElementById('incidentsTableBody');
            tbody.innerHTML = '';

            incidents.forEach(incident => {
                const row = document.createElement('tr');
                
                const statusBadge = incident.status === 'resolved' ?
                    `<span class="badge bg-success">Resuelto</span>` :
                    `<span class="badge bg-danger">En curso</span>`;

                row.innerHTML = `
                    <td>${incident.start}</td>
                    <td><strong>${incident.monitor}</strong></td>
                    <td><span class="badge bg-warning">${incident.duration}</span></td>
                    <td>${incident.cause}</td>
                    <td>${statusBadge}</td>
                    <td>${incident.end || 'En curso'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateStats() {
            let totalUp = 0;
            let totalDown = 0;
            let totalMonitors = 0;

            Object.keys(allMonitors).forEach(group => {
                allMonitors[group].forEach(monitor => {
                    totalMonitors++;
                    if (monitor.status === 'up') {
                        totalUp++;
                    } else {
                        totalDown++;
                    }
                });
            });

            document.getElementById('monitorsUp').textContent = totalUp;
            document.getElementById('monitorsDown').textContent = totalDown;
        }

        function filterByGroup() {
            currentFilter = document.getElementById('groupFilter').value;
            loadMonitorsTable();
        }

        function updatePeriod() {
            const period = document.getElementById('periodFilter').value;
            // Aquí podrías cargar datos diferentes según el período
            console.log('Actualizando período a:', period);
        }

        // Funciones de exportación
        function exportJSON() {
            const period = document.getElementById('periodFilter').value;
            const group = document.getElementById('groupFilter').value;
            
            let monitorsToExport = [];
            
            if (group === 'all') {
                Object.keys(allMonitors).forEach(groupKey => {
                    allMonitors[groupKey].forEach(monitor => {
                        monitorsToExport.push({...monitor, group: groupKey});
                    });
                });
            } else {
                allMonitors[group].forEach(monitor => {
                    monitorsToExport.push({...monitor, group: group});
                });
            }

            const data = {
                timestamp: new Date().toISOString(),
                report_type: "icentral_downtime_report",
                period: period,
                filter: group,
                summary: {
                    total_monitors: monitorsToExport.length,
                    monitors_up: monitorsToExport.filter(m => m.status === 'up').length,
                    monitors_down: monitorsToExport.filter(m => m.status === 'down').length,
                    total_incidents: incidents.filter(i => group === 'all' || getMonitorGroup(i.monitor) === group).length
                },
                monitors: monitorsToExport,
                incidents: incidents.filter(i => group === 'all' || getMonitorGroup(i.monitor) === group)
            };
            
            const filename = group === 'all' ? 
                `icentral-report-${period}.json` : 
                `icentral-${group}-report-${period}.json`;
                
            downloadFile(JSON.stringify(data, null, 2), filename, 'application/json');
        }

        function exportCSV() {
            const period = document.getElementById('periodFilter').value;
            const group = document.getElementById('groupFilter').value;
            
            let csv = "Grupo,Monitor,Estado,Disponibilidad,Ultimo_Incidente,Tiempo_Caido_Total,Causa\n";
            
            Object.keys(allMonitors).forEach(groupKey => {
                if (group === 'all' || group === groupKey) {
                    allMonitors[groupKey].forEach(monitor => {
                        csv += `"${groupKey.toUpperCase()}","${monitor.name}","${monitor.status}","${monitor.uptime}%","${monitor.lastIncident || 'N/A'}","${monitor.totalDowntime}","${monitor.cause || 'N/A'}"\n`;
                    });
                }
            });
            
            const filename = group === 'all' ? 
                `icentral-monitors-${period}.csv` : 
                `icentral-${group}-monitors-${period}.csv`;
                
            downloadFile(csv, filename, 'text/csv');
        }

        function exportIncidents() {
            const period = document.getElementById('periodFilter').value;
            const group = document.getElementById('groupFilter').value;
            
            let csv = "Fecha_Inicio,Fecha_Fin,Monitor,Duracion,Causa,Estado\n";
            
            incidents.forEach(incident => {
                if (group === 'all' || getMonitorGroup(incident.monitor) === group) {
                    csv += `"${incident.start}","${incident.end || 'En curso'}","${incident.monitor}","${incident.duration}","${incident.cause}","${incident.status}"\n`;
                }
            });
            
            const filename = group === 'all' ? 
                `icentral-incidentes-${period}.csv` : 
                `icentral-${group}-incidentes-${period}.csv`;
                
            downloadFile(csv, filename, 'text/csv');
        }

        function exportMonitor(monitorName) {
            // Buscar el monitor específico
            let targetMonitor = null;
            let targetGroup = null;
            
            Object.keys(allMonitors).forEach(group => {
                allMonitors[group].forEach(monitor => {
                    if (monitor.name === monitorName) {
                        targetMonitor = monitor;
                        targetGroup = group;
                    }
                });
            });
            
            if (targetMonitor) {
                const monitorIncidents = incidents.filter(i => i.monitor === monitorName);
                
                const data = {
                    timestamp: new Date().toISOString(),
                    monitor_name: monitorName,
                    group: targetGroup,
                    current_status: targetMonitor.status,
                    uptime_percentage: targetMonitor.uptime,
                    total_downtime: targetMonitor.totalDowntime,
                    response_time: targetMonitor.responseTime,
                    incidents: monitorIncidents
                };
                
                const filename = `${monitorName.replace(/\s+/g, '_').toLowerCase()}-report.json`;
                downloadFile(JSON.stringify(data, null, 2), filename, 'application/json');
            }
        }

        function getMonitorGroup(monitorName) {
            for (const [group, monitors] of Object.entries(allMonitors)) {
                if (monitors.some(m => m.name === monitorName)) {
                    return group;
                }
            }
            return 'unknown';
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
